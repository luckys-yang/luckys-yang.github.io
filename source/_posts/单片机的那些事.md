---
title: 单片机的那些事
cover: /img/num147.webp
categories:
  - 单片机知识
comments: false
abbrlink: 3794b119
date: 2023-08-22 22:28:27
---



{% note blue 'fas fa-fan' flat %}参考文章{% endnote %}

 [STM32学习笔记 | 引起电源和系统异常复位的原因](https://shequ.stmicroelectronics.cn/forum.php?mod=viewthread&tid=629393)



## STM32系列

> 对于STM32来说，复位通常分为三种类型：系统复位、电源复位和备份域复位
>
> 1. 系统复位
>
> 除了RCC的复位标志和备份域中的寄存器外，系统复位会将其它全部寄存器都复位为复位值。
>
> 产生系统复位事件：
>
> ※    `NRST 引脚低电平`
>
> ※    `窗口看门狗计数结束`
>
> ※    `独立看门狗计数结束`
>
> ※    `软件复位`
>
> ※    `低功耗管理复位`
>
> 2. 电源复位
>
> 除备份域内的寄存器以外，电源复位会将其它全部寄存器设置为复位值。
>
> 产生电源复位条件：
>
> ※    `上电/掉电复位或欠压复位`
>
> ※    `在退出待机模式时`
>
> - 引起异常复位的原因
>
> **原因一：NRST引脚电平被拉低引起复位**
>
> 有些特殊环境，特别是大型工厂，外界或内部会使电源产生干扰信号，使STM32的NRST引脚电平被拉低，从而导致系统复位。
>
> **分析原因**：NRST引脚电平拉低20us就会引起系统复位，电源上一个纹波，或者外部静电都会引起电源被拉低20us。
>
> **解决办法**：电源滤波、使用隔离电源、添加屏蔽措施等。
>
> **原因二：欠压引起复位**
>
> 有些产品在设计之初没有综合计算负载（与STM32同电源），因负载过大，使其欠压，从而导致复位。
>
> **分析原因**：STM32除了上电和掉电复位之外，绝大部分STM32还有一个欠压复位，当电源电压 (VDD) 降至所选 VBOR 阈值以下时，芯片将复位。
>
> **解决办法**：选择负载更大的电源、通过软件配置合理的欠压值VBOR。
>
> **原因三：数字、模拟电源地压差引起复位**
>
> 有工程师将VSS 和 VSSA之间使用一个几欧，甚至几十欧的电阻连接，有时候（有大电流经过地线）就会因为电源地的压差导致芯片（电源）复位。
>
> **分析原因**：我们比较关注 VDD 和 VDDA 的关系，但忽略了 VSSA 和 VSS 压差需要小于 50mV这一点（具体可以看数据手册）。如果有大电流的情况，则会引起电源地存在压差。
>
> **解决办法**：尽量使用完全连接地的方式处理，比如0欧电阻，或者隔离电源。
>
> **原因四：看门狗超时喂狗引起复位**
>
> 有不少工程师设计低功耗产品时，使用了看门狗，但是他们往往忘记了芯片睡眠模式不能停止喂狗，从而导致看门狗复位。
>
> **分析原因**：STM32进入睡眠之后，看门狗依然继续在工作，如果不及时喂狗，芯片会产生看门狗复位。
>
> **解决办法**：进入睡眠之前设置更长的喂狗时间，同时不定期唤醒芯片进行喂狗。

> - 关于推挽输出
>
> 推挽输出既可以向负载灌电流，也可以从负载抽取电流。推拉式输出级既提高电路的负载能力，又提高开关速度
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230822224523.webp)
>
> 当Vin电压为V+时，上面的N型三极管控制端有电流输入，Q3导通，Q4截止，于是电流从上往下通过，提供电流给负载。经过上面的N型三极管提供电流给负载（Rload），这就叫「推」。
>
> 当Vin电压为V-时，下面的三极管有电流流出，Q4导通，Q3截止，于是电流从上往下流过。经过下面的P型三极管提供电流给负载（Rload），这就叫「挽」。
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230822224553.webp)

> 谈谈中断优先级问题
>
> 两个中断优先级相同情况下，都是假定中断请求在时间上错开了的情况。如果二者同时到达，那CPU先响应哪一个呢？就看二者在中断矢量表的序号，谁的序号小就先响应谁
>
> 所以有时候串口丢包啥的有可能就是中断优先级设置问题
>
> 当在系统里开启多个中断事件时，要合理安排各中断源的优先级，有些时候可能还需精心安排

> CubeMX配置里在配置引脚时，设置了某功能后按住 `CTRL+鼠标左键`，然后鼠标往外拖，就可以看到这个功能的其他备用引脚在闪烁了

> 时钟：
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230823085359.webp)

> STM32工作电压
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230823090431.webp)

> CAP引脚
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230823090547.webp)

> - 未使用的GPIO端口的处理
>
> 从目前一些工程师反应的意见来看，有如下几个解决方案：
>
> (1)  悬空，不做任何处理（不推荐）；
>
> (2)  将GPIO设置为输出方式（据说，可以抵挡外来的干扰，因干扰是输入类型的）；
>
> (3)  将使用的GPIO通过上拉或下拉电阻接电源或地（上拉或下拉电阻一般为10K欧姆）。

> 在Keil里定义变量没效果啥的，大概率程序没问题就是代码被优化了，在魔法棒那选择不优化那个选项即可

## 菜鸟电路分析

参考视频：[B站郭天祥](https://www.bilibili.com/video/BV12L411L7QG/?spm_id_from=333.788&vd_source=5fb3f08926cbdbc6d84b3f2bda38c0b1)



### 简单的直流电路也会暗藏玄机，KCL真好用

> `问题1`：U点电压等于多少？
>
> 答：流入的电流等于流出电流，通过下面计算出来
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230901133050.webp)
>
> `问题2`：5V高于3.3V，那电流会不会从5V那流到3.3V那？
>
> 答：其实关注点应该看U点求出的电压，可以看到是2/56V低于3.3V,所以是不会流到3.3V那的，同理如果把5V改成10V，通过上面计算结果此时是3.93V,高于3.3V，此时电流一定会流向3.3V的，但是这是理想中的，现实电路此时3.3V因为电流的倒灌导致损坏(相当于给一个不能充电的电池强行充电一样)

所以看电流是否经过某个元器件，首先需要看这个元器件的两端的电位，还有是否构成回路

 `还有两点之间有电流流过必然这两点有电势差`

> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230901135831.webp)
>
> 可以把两边电路看做两个节点，只有流出没有流入所以ab之间一定没有电流
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230901142226.webp)
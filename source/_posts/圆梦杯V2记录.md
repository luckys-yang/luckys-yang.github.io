---
title: 圆梦杯V2记录
cover: /img/num149.webp
categories:
  - 比赛
comments: false
abbrlink: ac6a7e5d
date: 2023-09-06 09:28:59
---



{% note blue 'fas fa-fan' flat %}参考文章{% endnote %}

[LED 灯带效果发生器](https://adrianotiger.github.io/Neopixel-Effect-Generator/)

[PWM+DMA驱动灯带](https://controllerstech.com/interface-ws2812-with-stm32/)

[STM32使用定时器实现微秒（us）级延时](https://iot-technology.blog.csdn.net/article/details/132403126)



> 注：因为原理图跟V1还是差不多的，所以此处就不详细记录基本的东西了，只记一下F1跟F4之间的移植遇到的问题等等，工程文件会上传到Github

## 框图

<img src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230905140323.webp" style="zoom:50%;" />



## 焊接

>  一开始焊完DCDC那上电后电解电容和DCDC芯片严重发热，后面我换了板子一个个元器件焊，最后焊完也是正常的，输出4.95V，可能是因为加热台不知道哪里虚焊或者短路了吧

> 焊完下载程序半天没效果，原因是拨码开关焊反了，导致地变高电平，正常是1,2丝印朝下，NO在上的，解决方法是把拨码开关全部打上面去，或者拆下来重新焊正
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230911081053.webp)

> DAPLINK那个下载座不能直接插那个下载器，暂时找不到原因，只能杜邦线接

> ASR正常，但是一开始不知道为啥不行8002A一直发烫严重，最后尝试换一块板子焊，然后就正常可以使用了，可能还是哪里虚焊或者啥的吧，但是我都看了也没看到哪里，然后ASR的PA4引脚需要高电平使能才能下载程序，一开始不知道悬空了，所以硬件上只能通过飞线到3.3V了，所以这个教训告诉我要认真看数据手册，不要粗心大意略过
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230911193102.webp)



## 资源分配

- 引脚分配

|  引脚   |   引脚功能    |      用作       |
| :-----: | :-----------: | :-------------: |
| **A7**  | **TIM3_CH2**  |    **E_R_B**    |
| **A6**  | **TIM3_CH1**  |    **E_R_A**    |
|   A5    |   TIM2_CH1    |      E_L_A      |
|   B3    |   TIM2_CH2    |      E_L_B      |
| **A4**  | **ADC1_IN4**  |  **Power_ADC**  |
| **B1**  | **ADC1_IN9**  |  **Fire_ADC**   |
| **B0**  | **ADC1_IN8**  |   **MQ2_ADC**   |
|   E2    |   上拉输入    |       L3        |
|   E3    |   上拉输入    |       L2        |
|   E4    |   上拉输入    |       L1        |
|   E5    |   上拉输入    |        M        |
|   E6    |   上拉输入    |       R1        |
|   C13   |   上拉输入    |       R2        |
|   C14   |   上拉输入    |       R3        |
| **C15** | **推挽输出**  |   **Buzzer**    |
|   D0    |   推挽输出    |     L_AIN1      |
|   D1    |   推挽输出    |     L_AIN2      |
| **A1**  | **TIM5_CH2**  |   **L_PWMA**    |
| **A2**  | **TIM5_CH3**  |   **R_PWMB**    |
|   D2    |   推挽输出    |     R_BIN1      |
|   D3    |   推挽输出    |     R_BIN2      |
| **D4**  | **开漏输出**  | **MPU6050_SCL** |
| **D7**  | **开漏输出**  | **MPU6050_SDA** |
|   C5    |   开漏输出    |   ESP01S_RST    |
|   D5    |   USART2_TX   |   BT_ESP01_TX   |
|   D6    |   USART2_RX   |   BT_ESP01_RX   |
| **C6**  | **USART6_TX** |   **ASR_TX**    |
| **C7**  | **USART6_RX** |   **ASR_RX**    |
|   B10   |   USART3_TX   |    openMV_TX    |
|   B11   |   USART3_RX   |    openMV_RX    |
| **B8**  | **开漏输出**  |  **SHT30_SCL**  |
| **B9**  | **开漏输出**  |  **SHT30_SDA**  |
|   B12   |   开漏输出    |    VL53_SCL     |
|   B13   |   开漏输出    |    VL53_SDA     |
| **E0**  | **上拉输入**  |     **K1**      |
| **E1**  | **上拉输入**  |     **K2**      |
|   D12   |   TIM4_CH1    |     WS2812B     |
| **B15** | **推挽输出**  |    **LED_1**    |
| **B14** | **推挽输出**  |    **LED_2**    |
|   A3    |   TIM5_CH4    |     C_Motor     |
| **A0**  | **推挽输出**  |   **LED_sys**   |
|   A9    |   USART1_TX   |     HMI_TX      |
|   A10   |   USART1_RX   |     HMI_RX      |
| **C0**  | **开漏输出**  | **EEPROM_SCL**  |
| **C1**  | **开漏输出**  | **EEPROM_SDA**  |
|   B6    |   推挽输出    |    OLED_SCL     |
|   B7    |   推挽输出    |    OLED_SDA     |

- 其他分配

| 名称  |                  用途                   |
| :---: | :-------------------------------------: |
| TIM9  |         串口2WiFI接收中断计数用         |
| TIM8  |      中断里MPU6050，编码器读取10ms      |
| TIM12 |       裸机任务调度，按键检测等1ms       |
| TIM13 | us延时不需要中断，设置频率最大arr最大值 |

- 中断分组

> 每一版都用,隔开

|             中断              | 主优先级 | 子优先级 |
| :---------------------------: | :------: | :------: |
|     DMA1 stream0(WS2812B)     |    3     |    0     |
| TIM9(串口2WiFI接收中断计数用) |    2     |    0     |
|      TIM2(左电机编码器)       |    3     |    0     |
|      TIM3(右电机编码器)       |    3     |    0     |
|            USART1             |    2     |    0     |
|            USART2             |    2     |    0     |
|            USART3             |    2     |    0     |
|            USART6             |    2     |    0     |
|      TIM12(裸机任务调度)      |    0     |    0     |
|   TIM8(MPU6050，编码器读取)   |    1     |    0     |







## 主要模块

### WS2812B

> 需要设置频率为800KHz



### 独立看门狗

- MX

![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230908155825.webp)

设置了4s，喂狗时间是3.5s间隔

### ADC

> 电池的话充满是12.6V，低于9V就要充电了
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230912210330.webp)





### us延时

MX在上面设置了，时钟分频看你是多少，72MHz就设置为72-1

```cpp
/*
* @function: Public_Delay_us
* @param: us -> 需要延时的时间(us)
* @retval: None
* @brief: 系统us延时
*/
static void Public_Delay_us(uint16_t us)
{
	// Set timer period for desired delay in microseconds
	__HAL_TIM_SET_AUTORELOAD(&htim13, us - 1);//定时器响应时间为period*定时器频率
	HAL_TIM_Base_Start(&htim13);//start the timer
	//通过轮询的方式等待定时器的更新事件
	//当定时器溢出并计数器更新时，TIM_FLAG_UPDATE标志会被置位。
	while(__HAL_TIM_GET_FLAG(&htim13,TIM_FLAG_UPDATE)==RESET);
	__HAL_TIM_CLEAR_FLAG(&htim13,TIM_FLAG_UPDATE);//清楚更新标志位
	HAL_TIM_Base_Stop(&htim13);//Stop the timer
}
```



## 问题

> 下载程序的话这样设置
>
> ![](https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/QQ截图20230907180039.webp)

> F4的ADC校准函数应该是取消了，故不需要校准

> 结构体有个问题就是结构体本身里面的函数指针如果参数是自己的类型的话会报警告，解决方法是在typedef struct后面加一个结构体名称然后形参也需要加struct像这样：
>
> ```cpp
> // 这个是报警告的
> typedef struct
> {
>     void (*Set)(AA *a);
> }AA;
> 
> // 这个是没有警告的
> typedef struct AA
> {
>     void (*set)(struct AA *a);
> }AA;
> ```

> 因为画原理图分配引脚时忘记考虑定时器的ARR最大范围问题，所以左轮的编码器定时器最大值是0xFFFFFFFF，在程序里的话还是使用-65536，试了换成-0xFFFFFFFF，但是效果好像差点，MX的话还是设置最大值